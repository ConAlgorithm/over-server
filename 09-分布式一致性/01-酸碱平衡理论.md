## 一  什么是一致性问题

在互联网系统中，一致性指分布式服务化系统之间的弱一致性，包括：系统的一致性和数据的一致性。  

常见的一致性问题：  
- 案例1：下单与库存。如果先下单，扣库存失败，会导致超卖，如果下单不成功，扣库存成功，那么会导致少卖
- 案例2：网络延迟。系统A同步调用系统B超时，A能够得到超时反馈，但是无法确定B是否已经完成了调用功能
- 案例3：缓存与数据库不一致
- 案例4：缓存本身不一致，如缓存节点之间不一致  

## 二 酸碱平衡理论

#### 2.1 盐 ACID   

单一的关系型数据库具备ACID特性，支持强一致性，即：
- A：Atomicity，原子性
- C：Consistency，一致性
- I：Isolation，隔离性
- D：Durability，持久性

传统关系型数据库如MySQL支持强一致性，即：系统本身不会出现不一致，每个事务都是原子的，或者成功或者失败，事务之间是隔离的，完全不受影响。这种功能通常由多版本控制协议MVCC实现。    

这在传统软件中得到了验证，但是面对大规模、高并发的互联网系统，往往采用拆分策略，很难讲相关数据分到同一个数据分片，这时需要实现最终一致性。  
#### 2.2 帽子理论 CAP

由于对系统或者数据进行了拆分，我们的系统不再是单机系统，而是分布式系统，针对分布式系统的 CAP 原理包含如下三个元素：
- C: 一致性（Consistency），在分布式系统中的所有数据备份，在同一时刻具有同样的值，所有节点在同一时刻读取的数据都是最新的数据副本。
- A: 可用性（Availability），完全的可用性指的是在任何故障模型下，服务都会在有限的时间内处理完成井进行响应。
- P: 分区容忍性（Partition tolerance），尽管网络上有部分消息丢失，但系统仍然可继续工作 。

CAP 原理证明，任何分布式系统只可同时满足以上两点 ，无法三者兼顾 。 由于关系型数据库是单节点无复制的，因此不具有分区容忍性，但是具有一致性和可用性，而分布式的服务化系统都需要满足分区容忍性，那么我们必须在一致性和可用性之间进行权衡。如果在网络上有消息丢失，也就是出现了网络分区，则复制操作可能会被延后，如果这时我们的使用方等待复制完成再返回 ，则可能导致在有限时间内无法返回，就失去了可用性；而如果使用方不等待复
制完成， 而在主分片写完后直接返回，则具有了可用性，但是失去了一致性 。  

#### 2.3 碱 BASE

解决一致性的方案:酸碱平衡理论。ACID即酸，BASE即碱。 

BASE思想与ACID不同，其满足CAP原理，通过牺牲强一致性获得可用性，一般应用于服务化系统的应用层或者大数据处理系统中，通过达到最终一致性来尽量满足业务的大多数需求：
- BA：Basically Available，基本可用
- S：Soft State，软状态，状态可以在一段时间内不同步
- E：Eventually Cinsisten，最终一致，在一定的时间窗口内，最终数据达成一致即可

CAP理论提出了分布式系统中，一致性和可用性不可兼得。其实在不同的场景下利用ACID和BASE（碱）来解决分布式服务化系统的一致性问题。

软状态是实现 BASE 思想的方法，基本可用和最终 一致是目标。以 BASE 思想实现的 系统 由于不保证强一致性，所以系统在处理请求的过程中可以存在短暂的不一致，在短暂的不一致 的时间窗口内，请求处理处于临时状态中，系统在进行每步操作时，通过记录每个临时状态，在系统出现故障时可以从这些中间状态继续处理未完成的请求或者退回到原始状态，最终达到一致状态。  

以转账为例，我们将用户 A 向用户 B 转账分成 4个阶段:第 l 个阶段，用户 A 准备转账; 第2个阶段，从用户A账户扣减余额:第3个阶段，对用户B增加余额;第4个阶段， 完成转 账。系统需要记录操作过程中每个步骤的状态， 一旦系统出现故障，系统便能够自动发现没有 完成的任务，然后根据任务所处的状态继续执行任务，最终彻底完成任务， 资金从用户 A 的账 户转账到用户 B 的账户，达到最终的一致状态。  

在实际应用中，上面这个过程通常是通过持久化执行任务的状态和环境信息， 一旦出现问题，则定时任务会捞取未执行完的任务，继续执行未执行完的任务，直到执行完成，或者取消己经完成的部分操作并回到原始状态。这种方法在任务完成每个阶段时，都要更新数据库 中任 务的状态，这在大规模、高井发系统中不会有太好的性能， 一种更好的办法是用 Write-Ahead Log(写前日志)，这和数据库的 Bin Log (操作日志〉相似，在进行每个操作步骤时，都先写入日志， 如果操作遇到问题而停止，则可以读取日志井按照步骤进行恢复，继续执行未完成的工作， 最后达到一致的状态。写前日志可以利用机械硬盘的追加写来达到较好的性能，然而这是一种专 业化的实现方式，多数业务系统还是使用数据库记录的字段来记录任务的执行状态，也就是记录中间的 “软状态飞 一个任务的状态流转一般可以通过数据库的行级锁来实现，这比使用写前日志实现更简单、快速。  

有了 BASE 思想作为基础，我们对复杂的分布式事务进行拆解，对其中的每个步骤都记录 其状态 ，有问题时可以根据记录的状态来继续执行任务，达到最终一致。

#### 2.4 酸碱平衡总结

- 关系型数据库（例如 Oracle 、 DB2 和 MySQL),能够保证强一致性，能用向上扩展解决的问题都不是问题
- 如果向上扩展的成本很高，则可以对廉价数据库如MySQL进行水平伸缩和分片，将相关数据分到数据库的同一个片上，仍然保证事务
- 如果业务规则限制，无法将相关数据分到同一个分片上，就需要实现最终一致性，在记录事务的软状态（中间状态、临时状态）时若出现不一致，则可以通过系统自动化或者人工干预来修复不一致的问题。
