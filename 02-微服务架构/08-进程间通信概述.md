## 一 进程通信（IPC）方式

传统单体应用中，模块之间通信依靠的是语言级的方法调用，开发人员通常不考虑进程间通信。  

在分布式系统中，服务实例通常是在多台机器上运行的进程，实例之间必须使用进程通信进行交互。  

常见进程间通信机制：
- 基于同步请求、响应的通信机制：REST/rpc
- 基于异步消息的通信机制：AMQP/STOMP等  

客户端与服务端之间的交互方式也需要考虑
- 一对一还是一对多：
  - 一对一：每个客户端请求由一个服务实例处理
  - 一对多：每个客户端请求由多个服务实例处理
- 同步还是异步：
  - 同步：客户端请求需要实时响应，等待期间会阻塞
  - 异步：客户端请求不要求实时，等待是非阻塞的

这两个维度的互相交叉会诞生多种技术方案：
| 维度 | 一对一 | 一对多 |  
|------|------|------|
| 同步模式 | 请求/响应 | 无 |
| 异步模式 | 异步请求/响应 单向通知 | 发布/订阅 发布/异步响应 |

一对一方式交互时候的场景：
- 请求/响应：客户端发出请求后等待服务器响应，等待过程会造成线程阻塞
- 异步请求/响应：服务端对请求进行异步响应，等待响应中不会阻塞线程，因为服务端的响应不会马上返回
- 单向通知：客户端的请求不期望服务端做出任何响应

一对多方式交互时候的场景：
- 发布/订阅：客户端发布通知消息，被0-多个感兴趣的服务订阅
- 发布/异步响应：客户端发布请求消息，然后等待从感兴趣的服务发回的响应


## 二 远程过程调用(RPI) 

### 2.1 RPI概述

客户端中的业务逻辑调用代理接口（由远程过程调用代理适配器来实现），该适配器通过接口调用服务的业务逻辑，并将回复发送回远程调用代理，最终代理将结果返回给客户端。  

常见的实现方式有：
- REST
- RPC：即Remote Procedure Call，远程过程调用，是常用的进程间通信方式，允许程序调用另外一个地址空间的过程/函数，无需开发者显式的书写远程调用细节。开发者在使用这些远程地址上的函数时，其调用方式和本地方式一致。  

### 2.2 REST

REST强调资源，通常表示单个业务对象，如客户、产品、业务对象等，使用HTTP才操作，资源以XML或者JSON等格式返回。  

REST优点：
- 简单好用，测试方便
- 直接支持请求/响应方式的通信
- http对防火墙友好
- 不需要中间代理，简化了系统架构

REST弊端：
- 只支持请求/响应方式
- 客户端必须知道服务实例的位置，引起了架构中服务发现机制
- 严格遵守REST标准定义API很困难

### 2.3 RPC

常见的rpc框架是grpc。  

优点：
- 复杂API设计起来简单
- 通信更高效
- 支持在远程过程调用和消息传递过程中使用双向流式消息方式
- 实现了客户端和各种语言编写的服务端之间的互操作性

弊端：
- JavaScript操作rpc的API需要额外处理很多
- 旧式防火墙不支持http/2

### 2.4 局部故障问题

rpc与rest都是同步通信机制，会引起局部故障问题：  

```
分布式系统中，服务试图向另一个服务发送同步请求时，由于客户端和服务端是互相独立的进程，服务端可能无法再有限时间内对客户端请求作出响应，更可能因为故障而响应缓慢、暂停服务。  

此时客户端等待响应被阻塞，相应的其他客户端、第三方应用之间的传导都会造成影响，最终导致服务中断。
```

断路器：即远程过程调用的代理，在连续失败次数超过指定阈值后的一段时间内，这个代理会立即拒绝其他服务。  

常见代表软件有：Hystrix

## 三 通信的消息格式

通信时候，传递的消息（数据）格式也不尽相同，有：
- 基于文本：JSON/XML。可读性高，但是消息较为冗长会造成额外开销
- 基于二进制：Avro/Protocol Buffers。不具备可读性，但体积小，开销小