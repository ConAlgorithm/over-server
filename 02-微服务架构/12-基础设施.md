## 一 敏捷基础设施

微服务架构中，成千上万的服务很难管理，我们需要一套强大的基础设施，通过容器的封装环境，实现开发、测试、生产环境的一致，并能通过CI工具实现持续部署。  

敏捷基础设置一般是可编程的，在理想情况下，一套完善的基础设施可以让一个全栈工程师在没有运维的参与下，申请生成环境资源，自动化配置，部署应用。  

敏捷基础设施的目标：
- 标准化：基础设施没有个性化，必须保证开发环境、测试环境、生产环境的一致
- 可替换：任意节点都能够被轻易的创建、删除、替换
- 自动化：所有的操作都可以通过基础设施提供的界面、工具进行自动化完成，无需人工干预
- 可视化：当前环境的状况可以实时可视
- 可追溯：所有的配置统一作为代码进行版本化管理，所有的操作都可以追溯
- 高性能：资源申请和释放需要秒级完成，以适应弹性伸缩、故障切换要求

## 二 敏捷基础设施常用软件

当前敏捷基础设施核心组件是容器，如Docker。  

在容器基础上还有一些管理软件、配置软件、编排软件：
- Kubernetes
- Ansible
- Chef
- SaltStack
- Terraform

## 三 监控告警服务

### 3.1 应用为中心的监控系统概念

监控报警系统主要用于两个场景：
- 出错报警
- 阈值警告
  - 海恩法则：1次严重事故背后必定是：29次轻微事务+300次未遂先兆+1000次事故隐患

传统的监控方式强调以资源为中心，如：CPU、内存、带宽等，这种监控方式不精确，容易误报。  

现代监控方式向应用方向倾斜，如：订单量突然下降一半是否存在问题，吞吐量达到阈值后先关注其他的系统是否有问题，再弹性伸缩。  

### 3.2 监控数据采集

常用监控数据的采集有三种：
- 直接上报：在物理机、容器内，应用通过SDK直连监控服务，向监控中心发送或者通过监控中心拉取监控数据
- 日志上报：在物理机、容器内，应用通过SDK打印规定格式日志，监控中心通过日志收集组件收集响应信息，并做大数据大数据分析
- agent上报：在物理机、容器内，监控系统会在镜像中默认安装一个agent，用来获取各种系统的监控指标

### 3.3 监控数据接收方式

监控数据接收模式有：推（push）、拉（pull）两种模式

### 3.4 监控数据存储方式

现代监控系统主要以时序数据库为存储方式，因为要监控的数据基本都包含了时间。基于时间序列监控数据是目前的主流做法。  

目前主流的时序数据库有:
- InfluxDB
- Druid

时序数据库的特点：
- 写多读少，大部分时间是写入，写入是顺序的，但是读的时候并发量也有可能很高
- 数据量较大，内存一般放不下，属于I/O密集型
- 读操作的时候需要按照时间排序

## 四 开源监控中心实现

### 4.0 开源监控中心实现技术

一个成熟的开源监控中心需要依赖很多技术的组合：
- Prometheus：开源监控系统，是一套监控、报警、时序数据库的组合
- Grafana：可以以Prometheus作为数据源进行监控展示

在大规模场景中，Prometheus也需要扩展，常见的有：Cortex、Thanos


### 4.1 Prometheus

Prometheus是一套开源的监控、报警、时序数据库组合。其特点如下：
- 时序数据库吞吐量很高
- 查询语言灵活（PromQL）
- 基于http的拉模式获取数据库，可以通过Pushgateway进行时序数据序列数据的推送
- 数据可视化全面

Prometheus架构：
- Retrieval：负责订货时去指定的API上抓取采样数据
- Storage：负责将采样数据持久化到磁盘
- PromQL：负责提供查询


