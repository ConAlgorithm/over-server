## 一 微服务通信方式简介

在传统单体应用中，模块之间通信依靠的是语言级的方法调用，开发人员通常不需要考虑进程间通信（IPC）。  

在微服务架构中，服务实例通常是在多台机器、容器中运行的进程，实例之间必须使用进程间通信进行交互。服务在注册中心注册地址后，就可以对服务发起远程调用。   

常见微服务通信机制有：
- 基于请求响应：
  - RPC
  - REST
- 基于消息通信：
  - AMQP
  - STOMP
  - ... 

贴士：在微服务中，大部分调用都是同步调用，异步调用常用于上游服务不会实时关注下游服务的调用结果，如：异步调用记录日志。 

## 二 RPC与REST对比

### 2.1 RPC

常见的rpc框架是grpc。  

优点：
- 复杂API设计起来简单
- 通信更高效
- 支持在远程过程调用和消息传递过程中使用双向流式消息方式
- 实现了客户端和各种语言编写的服务端之间的互操作性

弊端：
- JavaScript操作rpc的API需要额外处理很多
- 旧式防火墙不支持http/2

### 2.2 REST

REST强调资源，通常表示单个业务对象，如客户、产品、业务对象等，使用HTTP才操作，资源以XML或者JSON等格式返回。  

REST优点：
- 简单好用，测试方便
- 直接支持请求/响应方式的通信
- http对防火墙友好
- 不需要中间代理，简化了系统架构

REST弊端：
- 只支持请求/响应方式
- 客户端必须知道服务实例的位置，引起了架构中服务发现机制
- 严格遵守REST标准定义API很困难

相对于RPC，RESTFUL更加轻量、简单，直接支持跨语言，容器调试！  

## 三 微服务通信中的一些问题

### 3.1 雪崩

分布式系统中，服务试图向另一个服务发送同步请求时，由于客户端和服务端是互相独立的进程，服务端可能无法再有限时间内对客户端请求作出响应，更可能因为故障而响应缓慢、暂停服务。此时客户端等待响应被阻塞，相应的其他服务、客户端、第三方应用之间的传导都会造成影响，最终导致服务中断。  

这种现象即为`雪崩`，常用解决雪崩的方法有：
- 超时策略：设置较短的超时可以解决服务级联调用产生的阻塞问题。但是一个请求从发出到收到响应的时间是不确定的，在微服务架构中，需要根据成功调用一个服务调用链的平均时间来合理配置服务接口超时时间
- 熔断器机制：熔断器的模式使用断路器来检测故障是否已得到解决，在连续失败次数超过指定阈值后的一段时间内，需要一个代理来立即拒绝其他服务，这个代理便是断路器，常见代表软件有：Hystrix。


### 3.2 客户端与服务端的请求交互方式

客户端与服务端之间的交互方式也需要考虑
- 一对一还是一对多：
  - 一对一：每个客户端请求由一个服务实例处理
  - 一对多：每个客户端请求由多个服务实例处理
- 同步还是异步：
  - 同步：客户端请求需要实时响应，等待期间会阻塞
  - 异步：客户端请求不要求实时，等待是非阻塞的

这两个维度的互相交叉会诞生多种技术方案：
| 维度 | 一对一 | 一对多 |  
|------|------|------|
| 同步模式 | 请求/响应 | 无 |
| 异步模式 | 异步请求/响应 单向通知 | 发布/订阅 发布/异步响应 |

一对一方式交互时候的场景：
- 请求/响应：客户端发出请求后等待服务器响应，等待过程会造成线程阻塞
- 异步请求/响应：服务端对请求进行异步响应，等待响应中不会阻塞线程，因为服务端的响应不会马上返回
- 单向通知：客户端的请求不期望服务端做出任何响应

一对多方式交互时候的场景：
- 发布/订阅：客户端发布通知消息，被0-多个感兴趣的服务订阅
- 发布/异步响应：客户端发布请求消息，然后等待从感兴趣的服务发回的响应