## 一 系统容量评估简介

在互联网时代，软件架构设计使用服务化或者微服务架构对系统进行拆分，拆分后的系统职责单一，每个服务的业务逻辑简单，但是对非功能质量尤其是性能和容量需求的要求非常高。互联网架构权衡分析方法（ Architecture TradeoffAnalysis Method, AT灿的是评价软件构架的一种综合且全面的方法，它不仅可以揭示架构满足特定质量目标的情况，而且可以使我们更清楚地认识到质量与目标之间的制约和权衡。  

ATAM 是一个能够在项目开始实施之前评估架构是否能够满足这些非功能质 量的方法论 。这个方法论通过在架构设计的不同阶段提出不同的问题，来帮助架构设计人员发现架构设计上的问题，并在实践中总结出设计的模式，进而可以将这些模式应用到将来更多的项目中 。 


## 二 非功能质量需求

#### 2.0 非功能质量需求的概述

所谓非功能质量需求，即在开发的系统，不但要满足业务功能上的需求，如：订单、用户等管理，还要满足高可用、高性能、高安全性等非功能质量需求。  

常见非功能质量指标类表：
```
高性能：运行效率高、性价比高。指单节点服务的吞吐量和响应时间
可用性：持续可用性、缩短岩机时间、出错恢复、可靠性。全年时间减去当年的岩机时间，并用得到的差值除以全年时间计算得出，通常是表明服务质量的最核心的指标
可伸缩性：垂直伸缩、水平伸缩。指横向扩展的能力，也就是随着节点的增加，服务能力能够随着节点增加而线性增加，如果不能，则也可以使用百分比来衡量
可扩展性：可插拔、组件重用。指架构上的灵活性及可插拔性，将来可以不断地在系统上叠加新业务和新功能
安全性：数据安全、加密、熔断、防攻击。指系统的安全保护措施，要防止攻击和数据泄露等 
可监控性：快速发现、定位和解决。帮助开发人员和应急人员快速发现问题
可测试性：可灰度、可预览、可 Mock、可拆解。指我们开发的服务一定要在不同的阶段有相应的方法和途径来测试，包括 QA 测试、准生产测试和生产测试等，不具备测试条件的系统使用 Mock 等方式来解决。
鲁棒性：容错性、可恢复性。表明系统的容错性、健壮性和可恢复性
可维护性：易于维护、监控、运营和扩展。指系统要易于监控、运营和扩展
可重用性：可移植性、解耦。系统具有模块化、可移植、可通过迭代增加新功能的特性
易用性：可操作性。指系统对用户友好，方便系统的各类用户使用。
```

#### 2.1 应用服务器指标

应用服务器是服务的入口，请求流量从这里进入系统，数据库、缓存和消息队列的访问取决于应用服务器的访问量。对应用服务器的访问量进行评估至关重要，应用服务器主要关心每秒请求的峰值及对请求的响应时间等指标，通过这些指标可以评估我们需要的应用服务器资源的数量。  

部署结构：
```
负载均衡策略
高可用策略
I/O 模型（ NIO/BIO)
线程池模型
线程池中的线程数量
是否多业务混合部署
```

容量与性能指标：
```
1 每天的请求量
2 各接口的访问峰值
3 平均的请求响应时间
4 最大的请求响应时间
5 在线的用户盘
6 请求的大小
7 网卡的 l/O 流量
8 磁盘的 uo 负载
9 内存的使用情况
10 CPU 的使用情况
11 请求的内容是否包含大对象
12 GC 收集器的逃型和配置
```

#### 2.2 数据库

根据应用层的访问量和访问峰值，计算出需要的数据库资源的吞吐量、每天的数据总量等，由此来评估所需数据库资源的数量和配置、部署结构等。  

部署结构：
```
1 复制模型
2 失效转移策略
3 容灾策略
4 归档策略
5 读写分离策略
6 分库分表（分片）策略
7 静态数据和半静态数据是否使用缓存
8 有没有考虑缓存穿透并压垮数据库的情况
9 缓存失效和缓存数据预热策略
```

容量和性能的相关指标:
```
当前的数据容量
每天的数据增量（预估容量）
每秒的读峰值
每秒的写峰值
每秒的事务量峰值
查询是否走索引
有没有大数据量的查询和范围查询
有没有多表关联，关联是否用到索引
有没有使用悲观锁，是否可以改造成乐观锁，是否可以利用数据库内置行级锁
事务和一致性级别
使用的 JDBC 数据源类型＆.连接数等配置
即开启 JDBC 诊断日志
有没有存储过程
伸缩策略（分区表、自然时间分表、水平分库分表）
水平分库分表实现方法（客户端、代理、 NoSQL)
```

####  2.3 缓存

根据应用层的访问量和访问峰值，通过评估热数据占比，计算缓存资源的大小井估算缓存资源的峰值，由此来计算所需缓存资源的数量、部署结构、 高可用方案等。  

部署结构：
```
复制模型
失效转移
持久策略
掏i汰策略
线程模型
预热方法
哈希分片策略
```

容量和性能的相关指标：
```
级有内容的大小
缀得内容的数量
缓平F内容的过期时间
级存的数据结构
每秒的读峰值
每秒的写峰值
冷热数据比例
是否有可能发生缓存穿透
是否有大对象
是否使用缓存实现分布式锁
是否使用缓存支持的脚本（ Lua)
是否避免了 Race Condition
缓存分片方法（客户端、代理、集群）
```

#### 2.4 消息队列

根据应用层的平均访问量和访问峰值，计算出需要消息队列传递的数据量，进而计算出所需的消息队列资源的数量、部署结构、高可用方案等。  

部署结构：
```
复制模型
失效转移
持久策略
```

相应指标：
```
每天平均的数据增量
消息持久的过期时间
每秒的读峰值
每秒的写峰值
每条消息的大小
平均延迟
最大延迟
消费者线程池模型
哈希分片策略
消息的可靠投递
消费者的处理流程和持久机制
```

## 三 技术评审提纲
```
一 现状

1.业务背景
( 1 ）项目名称
( 2 ）业务描述

2.技术背景
( 1 ）架构描述 。
( 2 ）当前的系统容量（系统调用量的平均值、请求响应时间的平均值等） 。
( 3 ）当前系统调用量的峰值、最小和最大的请求响应时间 。

二 需求

1. 业务需求
( 1 ) 要改造的内容 。
( 2 ）要实现的新需求。

2. 性能需求
( 1 ）预估系统容量（预估系统调用量的平均值、预估请求响应时间的平均值） 。
( 2 ）预估系统调用量的峰值、最小和最大的请求响应时间 。
( 3 ）其他非功能质 量 ，例如： 安全性、可伸缩性等。

三 方案描述

1.概述
2.详细说明：
    中间件架构（应用服务器、数据库、缓存、消息队列等〉。
    逻辑架构（模块划分、模块通信、信息流、时序等）。
    数据架构（数据结构、数据分布、拆分策略、缓存策略、读写分离策略、查询策略、数据一致性策略）。
    异常处理、容灾策略、灰度发布、上线方案、回滚方案等 。
3.性能评估
    给出方案的基准数据，并按性能需求评估需要使用的资源数量。
    单机井发量。
    单机容量。
    单机吞吐量的峰值 。
    按照预估的性能需求，预估资源数量（应用服务器、缓存、存储、队列等）、伸缩方式和功能。
4.方案的优缺点
    优缺点要具有确定性，不要有“存在一定风险”这种描述，即要量化，有明确的目标和结果。
5.与其他方案对比
6.风险评估
    标识所选方案的风险，提出此风险发生时的应对策略，例如上线失败时的回被策略 。

四 工作量评估

描述使用所选方案时需要做的具体工作，井评估开发、测试等细化任务需要的时间，形成
可实施的任务计划表，计划表一般从项目计划和人员分配两个角度来管理项目，推荐采用简单
的 Excel 表，以减少工具使用和学习的曲线及成本。
```

## 四 性能评估参考标准

以下标准是使用 PC X86 桌面机器的经验值，并不代表使用线上生产机器的经验值，仅供参考，评审时应该根据机器的不同进行调整 。

#### 4.1 通用标准

- 容量按照峰值的 5 倍冗余计算 。
- 分库分表后的容量一般可存储 30 年的数据。
- 第三方查询接口吞吐量为 5000/s
- 单条数据库记录占用大约 1KB 的空间。

#### 4.2 常用软件

MySQL
- 单端口读 ： 1000/s 。
- 单端口写 ： 700/s 。
- 单表容量： 5000 万条

Redis
- 单端口读 ： 40000/s 。
- 单端口写 ： 40000/s 。
- 单端口 内 存容量 ： 32GB

Kafka
- 单机读 ： 30000/s 。
- 单机写 ： 5000/s

DB2
- 单机读峰值 ： 20000/s 。
- 单机写峰值 ： 20000/S o
- 单表容量： 1 亿条数据

#### 4.3 硬件

寄存器和内存
- 寄存器、 L2 、 L3 、 内存、分支预测失败、 互斥量加锁和解锁等耗时为纳秒级别 。
- 内存随机读取可达 30 万次Is，顺序读取可达 500 万次Is 。
- 内存每秒可 以读取 GB 级别的数据 。
- 读取内 存中 lMB 的数据为 250ns ，为亚毫秒级 。

硬盘 1/0
- 普通的 SATA 机械硬盘 IOPS 能达到 120 次／s
- 普通的 SATA 机械硬盘顺序读取数据可达 lOOMB/s 。
- 普通的 SATA 机械硬盘随机读取数据可达 2MB/s 。
- 普通的 SATA 机械硬盘旋转半圈需要 3mso
- 普通的 SATA 机械硬盘寻道需要 3ms 。
- 普通的 SATA 机械硬盘在己经寻道后（找到了要读取的磁道，也找到了要读取的扇区 〉开始读取数据，读取一次数据真正的耗时为 2ms 。
- FusionIO 卡（ 一种高的 SSD 硬盘套件〉可达到百万级别的 IOPS 。
- 高端机器如 IBM、华为等的服务器配上高端的存储设备，可以达到每秒 GB 级别的数据读取，相当于普通内存的读取速度。
- 固态硬盘访问延迟： 0.1 ～0.2ms，为亚毫秒级别，和内存速度差不多 。

网络 110
- 常见的千兆网卡的传输速度为 1OOOMbit/s，即 128Mbit/s 。
- 千兆网卡读取 IMB 数据： 10ms 

数据库
- 读写数据库中的一条记录在毫秒级别，短则几毫秒，多则几百毫秒，大于 500ms 一般
认为超时 。
- MySQL 在 4 核心、 256GB 内存的 CPU 中性价比最好，继续垂直扩展时由于体系结构
的限制，成本开始增加，提升的性能开始减少，性价比开始降低

IDC:
- 同一机房网络来回： 0.5ms
- 异地机房来回： 30～ 1OOms
- 同一机房的 RPC 服务调用为几个毫秒，有的为几十毫秒或者几百毫秒， 一般设置 500ms以上为超时。

网站：
网站
- 网页加载为秒级别。
- UV: 每日一共有多少用户采访，用 Cookie Session 跟踪。
- 独立 IP 访问：每日有多少独立 E 来访，同一个局域网可看到同一个 IP 。
- PV：每日单独用户的所有页面访问量。如果每日 UV 为 50 000 000，那么每秒的平均在线人数为 50 000 000124160160 = 578 人，还要知道这一秒内每个用户都在做什么，如果每秒内都在做一次查询操作，那么需要有一个能承受 5781s 吞吐量的机器。
- 某社交媒体平台每秒的写入量上万，每秒的请求量上百万，每天登录的用户上亿 ，每天产生的数据量产千亿。

组合计算和估算
- 普通的 SAIA 机器硬盘一次随机读取的时间为 ： 3ms （磁盘旋转） + 3ms （寻道） + 2ms（存取数据延迟） = 8ms 。
- 普通的 SAIA 机器硬盘每秒随机读取 ： 1OOOms / 8ms = 125 次 IOPS
- IOPS 代表磁盘每秒可随机寻址多少次，随机读取速度取决于数据是如何存放的，如果数据按照块存放，每块 4KB，每次读取 10 块，那么随机读取速度为： 10 × 4KB × 125次/s= 5MB/s
- 一次读取内存 的时间： 1OOOms / 30 万次/s= 3ns 。
- CPU 速度＝ 10 倍×内存速度＝ 100 倍 × I/O 速度。
- 顺序读取普通 SAIA 机械硬盘 lMB 的数据： 20ms 。
- 请记住： 2<sup>10</sup> =1KB, 2<sup>20</sup> = 1MB, 2<sup>30</sup> = IGB, 2<sup>32</sup> = 4GB



