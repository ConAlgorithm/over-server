## 一 架构设计原则

- 合适原则：**合适优于业界领先**！设计架构并不是都要采用业界领先的技术方案，领先意味着周边资料稀缺，也意味着架构有走向不切实际的错误倾向
- 简单原则：**简单优于复杂**! 并不是将系统设计的复杂才会显得高端，简单的架构往往更能适应业务的变化、团队的精通
- 演化原则：**演化优于一步到位**！ 提醒自己不要贪大求全，或者盲目照搬大公司的做法。应该认真分析当前业务的特点，明确业务面临的主要问题，设计合理的架构，快速落地以满足业务需要，然后在运行过程中不断完善架构，不断随着业务演化架构。

## 二 《从零开始学架构》中的一个案例

### 2.0 案例背景

我们假想一个创业公司，名称叫作“前浪微博”。前浪微博的业务发展很快，系统也越来越多，系统间协作的效率很低，例如：
- 用户发一条微博后，微博子系统需要通知审核子系统进行审核，然后通知统计子系统进行统计，再通知广告子系统进行广告预测，接着通知消息子系统进行消息推送……一条微博有十几个通知，目前都是系统间通过接口调用的。每通知一个新系统，微博子系统就要设计接口、进行测试，效率很低，问题定位很麻烦，经常和其他子系统的技术人员产生分岐，微博子系统的开发人员不胜其烦。
- 用户等级达到 VIP 后，等级子系统要通知福利子系统进行奖品发放，要通知客服子系统安排专属服务人员，要通知商品子系统进行商品打折处理……等级子系统的开发人员也是不胜其烦

团队背景：
- 中间件团队规模不大，大约 6 人左右。
- 中间件团队熟悉 Java 语言，但有一个新同事 C/C++ 很牛。
- 开发平台是 Linux，数据库是 MySQL
- 目前整个业务系统是单机房部署，没有双机房

### 2.1 第一步：找出问题根源

这些问题的根源应该在于架构上各业务子系统强耦合，而消息队列系统正好可以完成子系统的解耦。

### 2.2 第二步：考察消息队列是否需要高性能
  
假设前浪微博系统用户每天发送 1000 万条微博，那么微博子系统一天会产生 1000 万条消息，我们再假设平均一条消息有 10 个子系统读取，那么其他子系统读取的消息大约是 1 亿次。1000 万和 1 亿看起来很吓人，但对于架构师来说，关注的不是一天的数据，而是 1 秒的数据，即 TPS 和 QPS。我们将数据按照秒来计算，一天内平均每秒写入消息数为 115 条，每秒读取的消息数是 1150 条；再考虑系统的读写并不是完全平均的，设计的目标应该以峰值来计算。峰值一般取平均值的 3 倍，那么消息队列系统的 TPS 是 345，QPS 是 3450，这个量级的数据意味着并不要求高性能。  

虽然根据当前业务规模计算的性能要求并不高，但业务会增长，因此系统设计需要考虑一定的性能余量。由于现在的基数较低，为了预留一定的系统容量应对后续业务的发展，我们将设计目标设定为峰值的 4 倍，因此最终的性能要求是：TPS 为 1380，QPS 为 13800。TPS 为 1380 并不高，但 QPS 为 13800 已经比较高了，因此高性能读取是复杂度之一。注意，这里的设计目标设定为峰值的 4 倍是根据业务发展速度来预估的，不是固定为 4 倍，不同的业务可以是 2倍，也可以是 8 倍，但一般不要设定在 10 倍以上，更不要一上来就按照 100 倍预估。 

### 2.3 第三步：考察消息队列是否需要高可用

对于微博子系统来说，如果消息丢了，导致没有审核，然后触犯了国家法律法规，则是非常严重的事情；对于等级子系统来说，如果用户达到相应等级后，系统没有给他奖品和专属服务，则VIP 用户会很不满意，导致用户流失从而损失收入，虽然也比较关键，但没有审核子系统丢消息那么严重。  

综合来看，消息队列需要高可用性，包括消息写入、消息存储、消息读取都需要保证高可用性。

### 2.4 第四步：考察消息队列是否需要高可扩展性

消息队列的功能很明确，基本无须扩展，因此可扩展性不是这个消息队列的复杂度关键。

### 2.5 第五步：设计备选方案

架构师常见的错误是：
- 总想设计最优秀的方案
- 只愿意做一个方案

如果架构评估不足，或者在实施时遇到重大问题，备选方案往往可以派上用场。备选方案的数量以 3 ~ 5 个为最佳，但是备选方案不需要过于详细。

## 三 架构设计文档

```
1 需求介绍
    介绍业务的现象，问题：性能问题、耦合问题、效率问题

2 架构设计总览
    展示架构图、对应描述

3 架构核心流程

4 架构详细设计
    高性能设计
    高可用设计
    可扩展设计
    安全设计
    部署方案

5 架构演进规划
```

还可以补充一些：
```
  需求分析
    5W：
        Who：利息相关者
        When：需求使用时间、里程碑
        What：需求的产出是什么
        Why：需求要解决的问题
        Where：需求的应用场景
    1H：
        How：关键业务流程
    8C：即8个约束（Constraints），包括性能、成本、时间、可靠性、安全性、合规性、技术性、兼容性

  复杂度分析
    分析系统的高可用、高性能、可扩展等设计

  备选方案
    包括介绍、评估等
```