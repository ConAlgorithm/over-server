## 一 高可用架构的衡量

业界通常使用多个9来衡量网站的可用性，如：
- QQ的可用性是4个9，即99.99%可用，即一年大约最多53分钟不可用
```
网站不可用时间 = 故障修复时间点 - 故障报告时间点
网站年度可用性指标 = (1 - 网站不可用时间 / 年度总时间) * 100%
```

对于大多数系统而言：
- 2个9基本可用，网站年度不可用时间小于88小时
- 3个9是较高可用，网站年度不可用时间小于9小时
- 4个9则具备自动回复能力，年度不可用时间小于53分钟
- 5个9是极高可用，网站年度不可用时间小于5分钟

## 二 高可用架构设计

#### 2.1 高可用架构整体设计

提升高可用手段：
- 企业级应用：通常购买昂贵硬件设备
- 互联网应用：通常使用廉价硬件与开源软件，提升手段主要是冗余备份、失效转移，通常不同的服务部署在不同的集群上，如下图：

![](../images/00-18.png)  

上图中：
- 应用层：通过负载均衡将一组服务器组成的集群共同对外提供服务，当负载均衡的心跳检测手段监控到某台服务器不可时，将该服务器从集群剔除
- 服务层：同样通过集群方式实现高可用，通过分布式服务调用框架访问，由该框架实现负载均衡，通过服务注册中心对提供服务的服务器进行心跳检测，发现服务不可用，立即通知客户端程序修改服务访问列表，剔除不可用服务器
- 数据层：保证数据写入时数据同步复制，写入多太服务器，实现数据冗余备份，宕机后，应用程序将访问切换到备份数据库服务器上

#### 2.2 应用层session管理

在2.1中，应用层可以利用负载均衡实现高可用，当应用是无状态时，这种高可用很容易实现。但是现实是业务总是有状态的，尤其是交易类电商网站的购物车、社交网站的登录状态等等。在集群中，保证每次请求能够获得正确的Session非常复杂。  

主要手段：
- Session复制：早期的集群Session管理机制，在集群中的服务器之间同步Session对象，每台都保存所有用户的Session信息，但是大量占用服务器和网络资源（通信原因），在大型系统中，用户可能达到千万，session异常庞大，该方案肯定不适合
- Session绑定：Session绑定可以利用负载均衡原地址Hash算法实现，负载均衡器将来源于同一IP的请求分发到同一台服务器上，该方法称为会话黏滞。该方案的缺点是被分发到的服务器一旦宕机，业务就暂停了。该方案很少使用。
- Session服务器：独立部署Session服务器集群，统一管理Session。其实就是讲应用服务器的状态进行了分离。

#### 2.3 服务层高可用

服务层一般负责提供基础公共服务，大型系统的基础服务通常采用分布式部署，然后被具体的应用远程调用。由于其也粗在无状态特性，可以使用类似负载均衡的失效转移策略实现高可用。  

具体实践中，还有以下方式：
- 分级管理：核心应用和服务采用更好的硬件，同时服务的部署也进行隔离避免连锁故障出现。低优先级的服务通过启动不同的线程或者部署在不同的虚拟机上进行隔离，高优先级的服务则需要部署在不同的物理机上，核心服务和数据可以部署在不同地域的数据中心。  
- 超时设置：超时后，应用程序根据服务调度策略，可选择继续重试或者请求转移
- 异步调用：异步调用可以避免一个服务失败导致整个应用请求失败，当然也不是所有服务都可以使用异步调用。
- 服务降级：高峰访问时期，可以采取降级手段（拒绝服务或者关闭服务）提升系统负载能力
- 幂等性设计：应用调用服务成功后因为网络原因没有收到响应，很容易造成重复调用，这在涉及转账类操作时，后果是严重的。在设计上，应用层不用关心该问题，服务层自身应该保证重复调用和一次调用的结果相同，即服务具有幂等性。有些服务本身是幂等的，比如设置人的性别的男，多少次都一样，但是转账之类的服务需要对交易编号进行校验。

#### 2.4 数据层高可用

保证数据高可用的手段主要是数据备份和失效转移机制。  

备份分为：
- 冷备份：早期手段，即定期将数据复制到存储戒指上物理存档，不能保证最终一致性
- 热备份
  - 异步热备：多分副本写入操作异步完成，应用程序在收到响应时其实只写入了一份，然后由主从机制控制从服务器异步写入
  - 同步热备：应用程序收到响应时多份数据写入成功，此时服务器没有主从之分，完全对等，便于管理，等待响应的时间是操作最慢的服务器的时间。

CAP理论：
- 数据持久性：数据持久化在多个备份上，不会因为某个存储故障而丢失数据
- 数据可访问性：在切换备份时，该过程完成较慢，或者切换时需停止用户访问数据，这段时间内数据是无法访问的
- 数据一致性：多备份时，需要保证多个备份写入数据的一致性

为了保证数据的高可用，会牺牲另一个指标，即数据一致性。  

CAP理论认为，数据存储系统无法同时满足数据一致性（Consistency），数据可用性（Availibility），分区耐受性（Patition Tolerance）.  

![](../images/00-19.png)  

大型系统中，数据的扩张速度极快，因此可伸缩性，也即耐受挫性比不好少，由于分布式的必定存在，必须保证分布式的高可用，所以通常大型系统都会采用存储系统的可用性A与伸缩性P，在一定程度上放弃一致性C。  

数据一致性可以分为如下几点：
- 数据强一致：各个副本的数据在物理存储中总是一致
- 数据用户一致：物理上可能不一致，但是终端用户访问时，通过纠错校验机制，保证一个确定、正确的数据返回
- 数据最终一致：较弱的一致性，物理存储和终端访问都有可能不一致（同一用户连续访问数据不一致），但是系统经过一段较短时间自我修正，数据最终到达一致

## 三 软件质量保证

#### 3.1 系统更新

在单机系统上，系统更新基本代表着服务器的重启，用户失去重启时间内的响应，在大用户量情况下，这种显现是不被允许的，可以采取如下措施：  
![](../images/00-20.png)

#### 3.2 其他措施

- 自动化测试
- 预发布验证：内部搭建一批没有配置负载均衡的服务器，用于验证新版系统
- 灰度发布：新版系统在线上发生故障后，需要回滚，在分布式集群环境中，回滚的时间漫长。为了避免该问题，可以每天只发布一定量的集群服务器，持续几天发布完毕。