## 一 docker容器简介

Docker将镜像文件运行起来后，产生的对象就是容器。容器相当于是镜像运行起来的一个实例。docker的容器实现了应用程序级别的隔离，docker将应用程序打包，使其可以在任何地方以相同的方式运行。  

容器与虚拟机的相同点：
- 容器和虚拟机一样，都会对物理硬件资源进行共享使用。 
- 容器和虚拟机的生命周期比较相似(创建、运行、暂停、关闭等等)。
- 容器中或虚拟机中都可以安装各种应用，如redis、mysql、nginx等。也就是说，在容器中的操作，如同在一个虚 拟机(操作系统)中操作一样。
- 同虚拟机一样，容器创建后，会存储在宿主机上:linux上位于/var/lib/docker/containers下

容器与虚拟机的不同点：
- 虚拟机的创建、启动和关闭都是基于一个完整的操作系统。一个虚拟机就是一个完整的操作系统。而容器直接运行在宿主机的内核上，其本质上以一系列进程的结合。
- 容器是轻量级的，虚拟机是重量级的。
  - 首先容器不需要额外的资源来管理，虚拟机额外更多的性能消耗;
  - 其次创建、启动或关闭容器，如同创建、启动或者关闭进程那么轻松，而创建、启动、关闭一个操作系统就没那么方便了。
- 也因为轻量，在给定的硬件上能运行更多数量的容器，甚至可以直接把Docker运行在虚拟机上。

## 二 容器常用命令

#### 2.1 容器创建与启动

查看容器列表：-a 参数会显示所有运行过的镜像
```
docker ps 
```

创建与启动：
```
# 创建待启动容器：docker create [参数命令] 依赖镜像 [容器内命令，用于容器启动时内部执行] [命令参数]
# -t 分配虚拟终端(TTY)， -i 没有连接也保持STDIN打开, --name 为容器起名，没起名则随机
docker create -it --name server01 nginx  

# 启动容器：docker start [容器名称]或[容器ID]   
# -a 将当前shell的 STDOUT/STDERR 连接到容器上 -i 将当前shell的 STDIN连接到容器上
docker start -a server01

```

快速创建新容器并启动(即同时执行了create和start)：
```
# 命令格式:  docker run [命令参数] [镜像名称][执行的命令] 
# 命令参数:  -t -i -d --name --rm  （-d表示守护进程启动-常用）
docker run -d --name server01 nginx /bin/echo "hello docker"
```

#### 2.2 常用命令：

```
# 重命名容器
docker rename [容器id]或[容器名称] [容器新名称]

# 查看容器运行日志：
docker logs [容器id] #命令效果:
docker logs 7c5a24a68f96

# 查看容器详细信息：
docker inspect [容器id]

# 查看容器网络信息：
docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' 930f29ccdf8a

# 查看端口
docker port [容器id]
```

#### 2.3 关闭、终止、删除

```
# 关闭：延迟关闭一个或多个处于暂停状态或者运行状态的容器 
docker stop 8005c40a1d16    # 可以是容器名或者容器ID

# 终止：强制并立即关闭一个或多个处于暂停状态或者运行状态的容器
docker kill 8005c40a1d16
```

删除容器：
```
# 普通删除：删除已关闭容器
docker rm 8005c40a1d16

# 强制删除：删除正在运行的容器
docker rm -f 8005c40a1d16

# 批量关闭容器
docker rm -f $(docker ps -a -q)
```

#### 2.4 进入、退出

创建容器的同时进入容器：
```
# 格式：docker run --name [container_name] -it [docker_image] /bin/bash
docker run -it --name panda-nginx nginx /bin/bash
echo "hello world"          # 进入容器后输出一句话
exit                        # 退出
```

退出容器：
```
exit 或者 ctrl+D
```

手工方式进入容器：
```
#命令格式:docker exec -it 容器id /bin/bash #效果演示:
docker exec -it d74fff341687 /bin/bash
```

脚本进入容器，创建如下脚本（文件名为docker_in.sh）：
```shell
#!/bin/bash
#定义进入仓库函数 
docker_in(){ NAME_ID=$1
  PID=$(docker inspect --format {{.State.Pid}} $NAME_ID)
  nsenter --target $PID --mount --uts --ipc --net --pid
}
docker_in $1
```

执行脚本
```
# 赋权执行
chmod +x docker_in.sh #进入指定的容器，并测试

# 运行脚本
./docker_in.sh b3fbcba852fd   
```

注意：报错 `-bash: ./docker_in.sh: /bin/bash^M`，是因为脚本文件在windows下编辑过，脚本文件在windows下编辑过。  
windows下，每一行的结尾是\n\r，而在linux下 文件的结尾是\n，那么你在windows下编辑过的文件在linux下打开看的时候每一行的结尾就会多出来一个字 符\r,用`cat -A docker_in.sh`时你可以看到这个\r字符被显示为^M，这时候只需要删除这个字符就可以了。 可以使用命令 `sed -i 's/\r$//' docker_in.sh`


## 三 基于容器创建镜像

方式一：将当容器版本升级
```
#命令格式: docker commit -m '改动信息' -a "作者信息" [container_id][new_image:tag] 

#命令演示:

# 第一步：执行一些操作
./docker_in.sh d74fff341687
mkdir /hello
mkdir /world
ls
exit

# 第二步：创建一个镜像
docker commit -m 'mkdir /hello /world ' -a "panda" d74fff341687 nginx:v0.2 

# 第三步：查看镜像，启动容器
docker images
docker run -itd nginx:v0.2 /bin/bash
./docker_in.sh ae63ab299a84           # 进入容器查看
ls
```

方式二：直接导出镜像
```
#命令格式: docker export [容器id] > 模板文件名.tar 

#命令演示:
docker export ae63ab299a84 > nginx.tar        # 导出
cat nginx.tar | docker import - panda-test    # 导入
```

import与load的区别: import可以重新指定镜像的名字，docker load不可以  

export 与 保存 save 的区别:
- export导出的镜像文件大小，小于save保存的镜像。
- export导出是根据容器拿到的镜像，再导入时会丢失镜像所有的历史。