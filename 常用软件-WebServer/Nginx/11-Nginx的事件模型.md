## 一 Nginx的事件对应的网络收发情况

Nginx类似一个事件的收集和分发者，在下列生产消费模型中，网络产生了各种事件（其实就是读、写等操作），而事件收集分发器则为这些事件建立对应的消费者。  

![](../images/webserver/nginx-03.png)  

### 2.2 事件驱动模型

事件驱动模型包括：
- 事件收集器：设一个事件循环所形成的程序，用来不断检查目前要处理的事件信息，然后用事件发送器传递给事件处理器，一般使用虚函数来实现
- 事件发送器：nginx的事件模型
- 事件处理器：负责执行对应的触发事件

事件处理器实现方式：
- 事件发送器每传递过来一个请求，目标对象创建一个新进程，调用事件处理器来处理
- 事件发送器每传递过来一个请求，目标对象创建一个新线程，调用事件处理器来处理
- 事件发送器每传递过来一个请求，目标对象将其加入一个待处理的列表，用非阻塞IO的方式调用事件处理器处理

第三种处理方式有许多事件驱动处理库，我们称之为多路IO复用方法，常见包括三种：
- select模型：Linux内置的基本事件驱动模型库，首先创建事件描述符集合，然后调用select()函数等待事件发生（阻塞），接着轮询集合中每一个事件描述符，检查是否有响应时间发生
- poll模型：Linux内置模型，是select库优化实现，与select基本相同，区别在于select需要将读、写、异常分别创建一个描述符集合，分别轮询三个集合，poll库只创建一个集合，在每个描述符对应的结构上分别设置读、写、异常事件，轮询时可以同时检查三种事件是否发生
- epoll模型： Linux效率最高模型，描述符列表的管理交给了内核负责，一旦有某种事件发生，内核把发生事件的描述符列表通知给进程，避免了轮询整个描述符列表，所以epoll库的效率不会随着描述符数量的增加而线性下降。

Nginx服务器还支持rtsig模型，kqueue模型（FreeBSD支持），dev/poll模型（Solaris支持），eventport模型（Solaris支持），通过不同的配置，实现Nginx对这些模型的支持。

### 3.3 RunLoops事件处理循环模型

RunLoops指进程内部用来不停的调配工作，对事件进行循环处理的一种模型，属于进程或者线程的基础架构部分。该模型对事件的处理不是自动的，需要在设计代码过程中，在适当的时候启动Run-Loop机制对输入的事件作出响应。  

该模型是一个集合，集合中的每一个元素称为一个Run-Loop，每个Run-Loop可运行在不同的模式下，其中可以包含它锁监听的输入事件源，定时器，以及在事件发生时需要通知的Run-Loop监听器（Run-Loop Observers）。为了监听特定事件，可以在Run Loops中添加响应的Run-Loop监听器。当被监听的事件发生时，Run-Loop会产生一个消息，被Run-Loop监听器捕获，从而执行预定的动作。  

Nginx服务器在工作进程中实现了Run-Loop事件处理循环模型的使用，用来处理客户端发来的请求事件，该部分的实现可以说是Nginx服务器程序实现中最为复杂的部分，包含了对输入事件繁杂的响应和处理过程，并且这些处理过程都是基于异步任务处理的。